My refactor of Himar's code (and the most important stuff)

