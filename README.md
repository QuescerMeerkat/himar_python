My refactor of Himar's code (only the most important stuff)

